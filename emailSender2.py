from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow
from google.auth.transport.requests import Request
from googleapiclient.discovery import build
import base64
from datetime import datetime, timedelta
from email.mime.text import MIMEText
import emailReader
from email.mime.multipart import MIMEMultipart


def send_message(service, sender, to, subject, info):
    """Send an email message."""
    status = 0
    try:
        message = create_message(sender, to, subject, info)
        sent_message = service.users().messages().send(userId='me', body=message).execute()
        print(f'Message sent: {sent_message}')
        status = status + 1
    except Exception as e:
        print(f'Error sending message: {e}')
        status = status - 1
    return status

def create_message(sender, to, subject, info):
    """Create a message for an email."""
    user_name = info.get_uName()
    group = info.get_group()
    preview = info.get_preview()
    #preview = full_post[:50] + "... see full post on Facebook!"
    link = info.get_link()
    date = info.get_date()
    part1 = """<html><table border="0" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td width="100%" align="center"><table border="0" cellspacing="0" cellpadding="0" align="center" style="border-collapse:collapse;"><tr><td width="1280" align="center"><body style="max-width:640px; margin:0 auto;" dir="ltr" bgcolor="#ffffff"><table border="0" cellspacing="0" cellpadding="0" align="center" id="email_table"style="border-collapse:collapse;max-width:640px;margin:0 auto;"><tr><td id="email_content" style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;background:#ffffff;"><table border="0" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td height="1" colspan="3" style="line-height:1px;"><span style="color:#FFFFFF;font-size:1px;opacity:0;">See what he posted.</span></td></tr><tr><td width="0" style="font-size:0;line-height:0;padding-left:15px;"></td><td><table border="0" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td style="line-height:0;font-size:0;padding-top:15px;" colspan="3">&nbsp;</td></tr><tr><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td><td align:"center" valign:"middle" width="100%" style="font-weight:bold;text-align:center;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;background:#ffffff;">Notibuddy</td><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td></tr><tr style="border-bottom:solid 1px #E4E6EB;"><td style="line-height:0;font-size:0;padding-top:15px;" colspan="3">&nbsp;</td></tr></table></td><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td></tr><tr><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td><td style=""><table border="0" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr style=""><td style="line-height:0;font-size:0;padding-top:25px;">&nbsp;</td></tr><tr><td style=""><span class="mb_text" style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:16px;line-height:21px;color:#141823;"></span></td></tr><tr><td style=""><table border="0" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td style="font-size:11px;font-family:LucidaGrande,tahoma,verdana,arial,sans-serif;background:#FFFFFF;border:solid 1px #E4E6EB;border-radius:6px;padding:15px;display:block;"><table border="0" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td><td width="100%" valign="middle" style=""><table border="0" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td style=""><span class="mb_text" style="color:#050505;font-size:16px;line-height:20px;font-weight:400;font-family:Roboto-Regular,Roboto,-apple-system,BlinkMacSystemFont,Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;"><a style="color:inherit;text-decoration:none;font-weight:bold;">"""
    part2 = """</a> posted in <a style="color:#050505;text-decoration:none;font-weight:bold;">"""
    part3 = """</a></span></td></tr><tr><td style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:14px;line-height:19px;color:#898f9c;"><span class="mb_text" style="font-family:Roboto-Regular,Roboto,-apple-system,BlinkMacSystemFont,Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:13px;line-height:16px;color:#65676B;font-weight:400;">"""
    part4 = """</span></td></tr></table></td></tr><tr style=""><td style="line-height:0;font-size:0;padding-top:8px;">&nbsp;</td></tr><tr><td colspan="3" style=""><table border="0" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td style=""><table border="0" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td style="font-size:11px;font-family:LucidaGrande,tahoma,verdana,arial,sans-serif;"><table border="0" width="auto" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td style="font-size:11px;font-family:LucidaGrande,tahoma,verdana,arial,sans-serif;"><table border="0" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td style="font-size:11px;font-family:LucidaGrande,tahoma,verdana,arial,sans-serif;"><table border="0" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td width="54" valign="top" style=""></td><td width="0" style="font-size:0;line-height:0;padding-left:12px;"></td><td width="100%" valign="middle" style=""></td></tr><tr style=""><td style="line-height:0;font-size:0;padding-top:8px;">&nbsp;</td></tr><tr><td colspan="3" style=""><table border="0" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td style=""><table border="0" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td style="font-size:11px;font-family:LucidaGrande,tahoma,verdana,arial,sans-serif;padding-bottom:4px;"><span class="mb_text" style="font-family:Roboto-Regular,Roboto,-apple-system,BlinkMacSystemFont,Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:14px;line-height:18px;font-weight:400;color:#050505;">"""
    part5 = """<br /></span></td></tr><tr><td style="font-size:11px;font-family:LucidaGrande,tahoma,verdana,arial,sans-serif;padding-top:4px;"><table border="0" width="auto" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td style="font-size:11px;font-family:LucidaGrande,tahoma,verdana,arial,sans-serif;"><table border="0" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td style="font-size:11px;font-family:LucidaGrande,tahoma,verdana,arial,sans-serif;padding-bottom:0px;"><table border="0" cellspacing="0" cellpadding="0" style="border-collapse:collapse;line-height:0;font-size:0;"><tr><td width="50%" colspan="1" style=""></td><td width="0" style="font-size:0;line-height:0;padding-left:8px;"></td><td width="50%" colspan="1" style=""></td></tr><tr></tr></table></td></tr><tr><td style="font-size:11px;font-family:LucidaGrande,tahoma,verdana,arial,sans-serif;padding-top:3px;"><table border="0" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr style=""><td style="line-height:0;font-size:0;padding-top:4px;" colspan="3">&nbsp;</td></tr></table></td></tr></table></td></tr></table></td></tr></table></td></tr><tr><td style=""></td></tr></table></td></tr></table></td></tr></table></td></tr></table></td></tr></table></td></tr><tr><td style=""></td></tr></table></td></tr></table></td></tr></table></td></tr></table></td><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td></tr><tr><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td><td style=""><table border="0" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr style=""><td style="line-height:0;font-size:0;padding-top:20px;">&nbsp;</td></tr><tr><td align="middle" style=""><a href="h"""
    part6 = """"" style="color:#1b74e4;text-decoration:none;"><table border="0" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;"><tr><td style="border-collapse:collapse;border-radius:6px;text-align:center;display:block;background:#1877f2;padding:8px 20px 8px 20px;"><a href="h"""
    part7 = """" style="color:#1b74e4;text-decoration:none;display:block;"><center><font size="3"><span style="font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;white-space:nowrap;font-weight:bold;vertical-align:middle;color:#FFFFFF;text-shadow:none;font-weight:500;font-family:Roboto-Medium,Roboto,-apple-system,BlinkMacSystemFont,Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:17px;">View&nbsp;on&nbsp;Facebook</span></font></center></a></td></tr></table></a></td></tr><tr style=""><td style="line-height:0;font-size:0;padding-top:8px;">&nbsp;</td></tr><tr style=""><td style="line-height:0;font-size:0;padding-top:40px;">&nbsp;</td></tr></table></td><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td></tr><tr><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td><td style=""><table border="0" width="100%" cellspacing="0" cellpadding="0" align="left" style="border-collapse:collapse;"><tr><td style="font-size:14px;color:#65676B;"><span style="padding-right:12px;font-family:Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;"></span></td></tr><tr style=""><td style="line-height:0;font-size:0;padding-top:15px;">&nbsp;</td></tr></table></td><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td></tr><tr><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td><td style=""><table border="0" width="100%" cellspacing="0" cellpadding="0" align="left" style="border-collapse:collapse;"><tr style="border-top:solid 1px #E4E6EB;"><td style="line-height:0;font-size:0;padding-top:15px;">&nbsp;</td></tr><tr><td style="font-family:Roboto-Regular,Roboto,-apple-system,BlinkMacSystemFont,Helvetica Neue,Helvetica,Lucida Grande,tahoma,verdana,arial,sans-serif;font-size:11px;color:#8A8D91;line-height:16px;font-weight:400;">Thanks for signing up for notifications from Notibuddy! </td></tr></table></td><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td></tr><tr><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td><td width="0" style="font-size:0;line-height:0;padding-left:0px;"></td></tr><tr style=""><td style="line-height:0;font-size:0;padding-top:20px;" colspan="3">&nbsp;</td></tr></table></td></tr></table></body></td></tr></table></td></tr></table></html>"""
    email_html = part1+user_name+part2+group+part3+date+part4+preview+part5+link[1:]+part6+link[1:]+part7
    message = MIMEText(email_html,'html')
    message['to'] = to
    message['from'] = sender
    message['subject'] = subject
    message = {'raw': base64.urlsafe_b64encode(message.as_bytes()).decode()}
    return message